<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - Louisville Emergency Response</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Chart.js (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    /* ====== creative emergency card styling ====== */
    .glass-card {
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.15);
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
      transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease;
      position: relative;
      overflow: hidden;
      isolation: isolate;
    }
    .glass-card:hover { transform: translateY(-2px) scale(1.01); box-shadow: 0 16px 40px rgba(0,0,0,0.18); }

    /* moving safety chevron band */
    .chevron-band::before {
      content: ""; position: absolute; inset: -1px; border-radius: 16px; z-index: -1;
      background: repeating-linear-gradient(135deg, rgba(255,255,255,.06) 0 10px, rgba(255,255,255,0) 10px 20px);
      mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      padding: 2px; -webkit-mask-composite: xor; mask-composite: exclude;
      animation: band 6s linear infinite;
    }
    @keyframes band { to { transform: translateX(40px); } }

    /* pulsing beacon dot */
    .beacon { position: absolute; top: 14px; right: 14px; width: 10px; height: 10px; border-radius: 9999px; }
    .beacon::after { content: ""; position: absolute; inset: -6px; border-radius: 9999px; border: 2px solid currentColor; opacity: .5; animation: ping 1.6s cubic-bezier(0,0,.2,1) infinite; }
    @keyframes ping { 0% { transform: scale(.8); opacity: .6 } 80%,100% { transform: scale(1.6); opacity: 0 } }

    /* neon edge on alert */
    .neon {
      box-shadow:
        0 0 0 1px rgba(255,255,255,.15) inset,
        0 0 20px var(--glow),
        0 0 40px var(--glow);
    }

    /* notification toasts */
    .notification{
      position:fixed;top:1.25rem;right:1.25rem;padding:.9rem 1.1rem;border-radius:.75rem;color:#fff;
      box-shadow:0 10px 15px -3px rgba(0,0,0,.15),0 4px 6px -2px rgba(0,0,0,.1);
      z-index:1001;transform:translateX(200%);transition:all .4s cubic-bezier(.68,-.55,.265,1.55);
      display:flex;align-items:center;max-width:420px;font-weight:600
    }
    .notification i{margin-right:.6rem;font-size:1.1rem}
    .notification.show{transform:translateX(0)}
    .notification.success{background:#10B981}
    .notification.error{background:#EF4444}
    .notification.warning{background:#F59E0B}

    .map-container { height: 500px; border-radius: 12px; overflow: hidden; position: relative; z-index: 1; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.3); }

    .severity-indicator{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:5px}
    .severity-1-3{background-color:#4CAF50}
    .severity-4-6{background-color:#FFC107}
    .severity-7-10{background-color:#F44336}
  </style>
</head>

<body class="font-sans bg-slate-100">
  <div id="admin-dashboard" class="min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-slate-900 via-blue-900 to-blue-700 text-white shadow-lg">
      <div class="container mx-auto px-4 py-4 flex justify-between items-center">
        <div>
          <h1 class="text-2xl font-bold tracking-tight flex items-center gap-2">
            <i class="fa-solid fa-shield-halved text-amber-400"></i>
            Louisville EMS Admin
          </h1>
          <div class="flex items-center mt-1 text-sm opacity-90 gap-2">
            <span id="admin-date"></span>
            <span class="opacity-40">•</span>
            <span id="admin-weather" class="flex items-center">
              <i id="admin-weather-icon" class="fa-solid fa-cloud mr-1"></i>
              <span id="admin-weather-temp">—</span>
            </span>
          </div>
        </div>

        <div class="flex gap-2">
          <a href="{{ url_for('admin_notify_page') }}" id="admin-notify" class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg transition flex items-center" aria-label="Notify User">
            <i class="fas fa-bell mr-2"></i>Notify
          </a>
          <button id="reset-storage" class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg transition flex items-center" aria-label="Reset Local Storage">
            <i class="fa-solid fa-rotate mr-2"></i>Reset
          </button>
          <a href="{{ url_for('home_page') }}" id="admin-logout" class="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg transition flex items-center" aria-label="Logout">
            <i class="fas fa-sign-out-alt mr-2"></i>Logout
          </a>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="container mx-auto px-4 py-8">
      <!-- Emergency cards (ONLY the 5 requested types) -->
      <div id="cards-container" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-5 gap-6 mb-10"></div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Recent Incidents -->
        <section class="bg-white rounded-lg shadow-md overflow-hidden">
          <div class="bg-slate-900 text-white px-6 py-4 flex items-center justify-between">
            <h2 class="text-xl font-bold">Recent Incidents</h2>
            <div class="text-xs opacity-80">Press 1–5 to filter by card</div>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Name</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Type</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Severity</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Time</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>
                </tr>
              </thead>
              <tbody id="incidents-table" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
          </div>
        </section>

        <!-- Map -->
        <section class="bg-white rounded-lg shadow-md overflow-hidden">
          <div class="bg-slate-900 text-white px-6 py-4 flex items-center justify-between">
            <h2 class="text-xl font-bold">Incident Map</h2>
            <div id="active-filter-chip" class="hidden text-xs px-3 py-1 rounded-full bg-amber-100 text-amber-800"></div>
          </div>
          <div class="map-container" id="admin-map" role="region" aria-label="Incident Map"></div>
        </section>
      </div>

      <!-- All reports -->
      <section class="mt-8 bg-white rounded-lg shadow-md overflow-hidden">
        <div class="bg-slate-900 text-white px-6 py-4">
          <h2 class="text-xl font-bold">All Incident Reports</h2>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Name</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Phone</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Emergency Type</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Severity</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Timestamp</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Resolved</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody id="all-incidents-table" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </section>

      <!-- Analytics button -->
      <div class="mt-6 flex justify-center">
        <a href="{{ url_for('all_incident_page') }}" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition flex items-center">
          <i class="fas fa-chart-bar mr-2"></i>Incident
        </a>
      </div>
    </main>
  </div>

  <script>
    /***************
     * APP CONSTANTS
     ***************/
    const STORAGE_KEY = 'louisvilleIncidents';
    const KNOWN_APP_KEYS = ['louisvilleIncidents','louisvilleUserReports','louisvilleReceiverReports','adminNotifs'];

    let incidents = [];
    let adminMap; let markersLayer = null;
    let currentFilter = null; // holds current type filter

    // ===== ONLY THE 5 REQUESTED TYPES =====
    const emergencyTypes = [
      { key: 'Water', name: 'Water', icon: 'fa-droplet', color: 'rgba(34, 197, 94, 0.85)', glow: '#22c55e' },
      { key: 'Power Outage', name: 'Power Outage', icon: 'fa-bolt', color: 'rgba(99, 102, 241, 0.85)', glow: '#6366f1' },
      { key: 'Medical Emergency', name: 'Medical Emergency', icon: 'fa-kit-medical', color: 'rgba(239, 68, 68, 0.85)', glow: '#ef4444' },
      { key: 'Building Collapse', name: 'Building Collapse', icon: 'fa-building', color: 'rgba(245, 158, 11, 0.9)', glow: '#f59e0b' },
      { key: 'Flood Warning', name: 'Flood Warning', icon: 'fa-water', color: 'rgba(14, 165, 233, 0.9)', glow: '#0ea5e9' }
    ];

    /*************** INIT ***************/
    document.addEventListener('DOMContentLoaded', () => {
      const forceReset = new URLSearchParams(location.search).get('reset') === '1';
      initializeStorage(forceReset);
      createEmergencyCards();
      initMap();
      refreshUI();

      document.getElementById('admin-logout').addEventListener('click', logout);
      document.getElementById('reset-storage').addEventListener('click', handleResetStorageClick);

      // Date/time ticker
      updateDate(); setInterval(updateDate, 60_000);

      // Hotkeys: 1..5 to filter by card
      window.addEventListener('keydown', (e) => {
        const n = Number(e.key);
        if (n >= 1 && n <= 5) { const t = emergencyTypes[n-1].name; setFilter(t); }
        if (e.key === '0') { clearFilter(); }
      });
    });

    /*************** STORAGE ***************/
    function initializeStorage(forceReset=false){
      if(forceReset){ clearAppStorage(); incidents=[]; saveIncidents(); showNotification('Local storage cleared (forced).','warning'); return; }
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw){ incidents=[]; saveIncidents(); return; }
      try{
        const parsed = JSON.parse(raw);
        if(!Array.isArray(parsed)) throw new Error('Invalid format');
        incidents = parsed.map(cleanIncident).filter(Boolean);
        saveIncidents();
      }catch(e){ incidents=[]; saveIncidents(); showNotification('Invalid saved data detected. Storage was reset.','warning'); }
    }
    function cleanIncident(i){
      if(!i) return null;
      const id = Number.isFinite(i.id) ? i.id : Date.now()+Math.floor(Math.random()*1000);
      const name = toText(i.name);
      const phone = toText(i.phone);
      const type = toText(i.type);
      const severityNum = Number(i.severity);
      const severity = Number.isFinite(severityNum) ? Math.min(10, Math.max(1, severityNum)) : null;
      const address = toText(i.address) || 'Downtown Louisville';
      const ts = new Date(i.timestamp); const timestamp = isNaN(ts.getTime()) ? new Date().toISOString() : ts.toISOString();
      const resolved = Boolean(i.resolved);
      const adminReply = typeof i.adminReply === 'string' ? i.adminReply.slice(0,2000) : '';
      if(!name || !phone || !type || !severity) return null;
      return { id, name, phone, type, severity, address, timestamp, resolved, adminReply };
    }
    function saveIncidents(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(incidents)); }
    function clearAppStorage(){ KNOWN_APP_KEYS.forEach(k=>localStorage.removeItem(k)); }

    /*************** UI BUILDERS ***************/
    function createEmergencyCards(){
      const container = document.getElementById('cards-container');
      container.innerHTML='';

      emergencyTypes.forEach((type, idx)=>{
        const id = type.name.toLowerCase().replace(/[^a-z]/g,'-')+'-count';
        const card = document.createElement('button');
        card.type = 'button';
        card.className = `glass-card chevron-band text-white p-5 text-left relative focus:outline-none focus:ring-2 focus:ring-white/40`;
        card.style.setProperty('--glow', type.glow);
        card.style.background = `linear-gradient(135deg, ${type.color} 0%, rgba(15,23,42,.9) 120%)`;
        card.setAttribute('data-type', type.name);
        card.setAttribute('title', `Press ${idx+1} to filter ${type.name}`);

        card.innerHTML = `
          <span class="beacon" style="color:${type.glow}"></span>
          <div class="flex items-start justify-between">
            <div class="space-y-1">
              <div class="text-xs uppercase tracking-widest/relaxed opacity-80">Emergency</div>
              <h3 class="font-extrabold text-lg sm:text-xl drop-shadow-sm">${escapeHTML(type.name)}</h3>
              <div class="flex items-center gap-2 text-xs">
              </div>
            </div>
            <i class="fas ${type.icon} text-2xl opacity-90"></i>
          </div>
          <div class="mt-4 flex items-end justify-between">
            <div>
              <p class="text-sm/5 opacity-80">Active alerts</p>
              <p id="${id}" class="text-4xl font-black tabular-nums">0</p>
            </div>
            <div class="flex gap-2">
              <span class="inline-flex items-center gap-1 text-xs px-2 py-1 rounded-md bg-white/10 border border-white/20"><i class="fa-solid fa-route"></i> Route</span>
              <span class="inline-flex items-center gap-1 text-xs px-2 py-1 rounded-md bg-white/10 border border-white/20"><i class="fa-solid fa-bullhorn"></i> Siren</span>
            </div>
          </div>`;

        card.addEventListener('click', () => setFilter(type.name));
        container.appendChild(card);
      });

      // Add a clear filter helper tile
      const clear = document.createElement('button');
      clear.className = 'glass-card text-slate-800 bg-white p-5 text-left';
      clear.innerHTML = `<div class="flex items-center gap-3"><i class="fa-solid fa-filter-circle-xmark text-2xl"></i><div><div class="text-xs uppercase tracking-widest text-slate-500">Filter</div><div class="font-bold">Show All</div><div class="text-xs text-slate-500">Press 0</div></div></div>`;
      clear.addEventListener('click', clearFilter);
      container.appendChild(clear);
    }

    /*************** MAP ***************/
    function initMap(){
      adminMap = L.map('admin-map', { zoomControl: true }).setView([38.2527, -85.7585], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' }).addTo(adminMap);
      markersLayer = L.layerGroup().addTo(adminMap);
      updateMapMarkers();
    }

    function updateMapMarkers(){
      if(!markersLayer) return; markersLayer.clearLayers();
      const neighborhoodCoords = {
        'Downtown Louisville':[38.254391,-85.762009], 'Old Louisville':[38.234711,-85.757019], 'Highlands':[38.227291,-85.708298], 'Germantown':[38.234291,-85.731476],
        'Butchertown':[38.257317,-85.724937], 'Clifton':[38.253872,-85.707451], 'Crescent Hill':[38.254616,-85.685394], 'St. Matthews':[38.252849,-85.655795],
        'Jeffersontown':[38.193699,-85.566368], 'Shively':[38.20007,-85.822741], 'Pleasure Ridge Park':[38.145313,-85.858253]
      };

      getVisibleIncidents().forEach(incident => {
        const [lat, lng] = getIncidentLatLng(incident, neighborhoodCoords);
        const markerColor = getMarkerColor(incident.type);
        const icon = L.divIcon({
          className: 'custom-icon',
          html: `<div style="background:${markerColor};width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700">${escapeHTML(incident.type.charAt(0))}</div>`,
          iconSize: [30,30], iconAnchor: [15,15]
        });
        const popup = `
          <div class="text-sm">
            <div class="font-bold mb-1">${escapeHTML(incident.type)}</div>
            <p><strong>Name:</strong> ${escapeHTML(incident.name)}</p>
            <p><strong>Phone:</strong> ${escapeHTML(incident.phone)}</p>
            <p><strong>Location:</strong> ${escapeHTML(incident.address)}</p>
            <p><strong>Severity:</strong> ${incident.severity}/10</p>
            <p><strong>Reported:</strong> ${formatDateTime(incident.timestamp)}</p>
            <p><strong>Status:</strong> ${incident.resolved ? 'Resolved' : 'Pending'}</p>
            <button class="text-blue-600 hover:text-blue-800 mt-2 underline" onclick="toggleResolved(${incident.id})">${incident.resolved ? 'Mark as Pending' : 'Mark as Resolved'}</button>
          </div>`;
        L.marker([lat,lng],{icon}).bindPopup(popup).addTo(markersLayer);
      });

      updateFilterChip();
    }

    function getMarkerColor(type){
      const m = {
        'Water': '#22c55e',
        'Power Outage': '#6366f1',
        'Medical Emergency': '#ef4444',
        'Building Collapse': '#f59e0b',
        'Flood Warning': '#0ea5e9'
      };
      return m[type] || '#6A5ACD';
    }

    /*************** FILTERING ***************/
    // Stable marker placement helpers (no jitter on refresh)
    function getIncidentLatLng(incident, neighborhoodCoords){
      // If explicit lat/lng were ever saved with an incident, honor them
      if (Number.isFinite(incident.lat) && Number.isFinite(incident.lng)) {
        return [incident.lat, incident.lng];
      }
      // Otherwise, compute a stable offset from the incident id
      const base = neighborhoodCoords[incident.address] || [38.2527, -85.7585];
      const dx = seededOffset(incident.id, 'x');
      const dy = seededOffset(incident.id, 'y');
      return [base[0] + dx, base[1] + dy];
    }

    function seededOffset(seedValue, axis){
      // Convert seed to string and build a small deterministic hash (djb2-xor)
      const str = String(seedValue) + ':' + axis;
      let h = 5381;
      for (let i = 0; i < str.length; i++) {
        h = ((h << 5) + h) ^ str.charCodeAt(i);
      }
      // Map unsigned 32-bit to [0,1)
      const u = (h >>> 0) / 4294967295;
      // Spread roughly ±0.004 degrees (~±400m) around the base point
      return (u * 0.008) - 0.004;
    }

/*************** FILTERING ***************/
    function setFilter(type){ currentFilter = type; refreshUI(); showNotification(`Filter: ${type}`,'success'); }
    function clearFilter(){ currentFilter = null; refreshUI(); showNotification('Filter cleared','warning'); }
    function getVisibleIncidents(){ return currentFilter ? incidents.filter(i => i.type === currentFilter) : incidents; }
    function updateFilterChip(){
      const chip = document.getElementById('active-filter-chip');
      if(currentFilter){ chip.textContent = `Showing: ${currentFilter}`; chip.classList.remove('hidden'); } else { chip.classList.add('hidden'); }
    }

    /*************** TABLES ***************/
    function refreshUI(){ updateMapMarkers(); updateRecentIncidentsTable(); updateAllIncidentsTable(); updateEmergencyCounts(); }

    function updateRecentIncidentsTable(){
      const tbody = document.getElementById('incidents-table'); tbody.innerHTML = '';
      const recent = [...getVisibleIncidents()].sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp)).slice(0,5);
      if(recent.length===0){ tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-6 text-center text-sm text-gray-500">No incidents reported yet.</td></tr>`; return; }
      recent.forEach(incident=>{
        const severityClass = getSeverityClass(incident.severity);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${escapeHTML(incident.name)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${escapeHTML(incident.type)}</td>
          <td class="px-6 py-4 whitespace-nowrap"><div class="flex items-center"><span class="severity-indicator ${severityClass}"></span><span class="text-sm text-gray-900">${incident.severity}/10</span></div></td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatTime(incident.timestamp)}</td>
          <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${incident.resolved ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${incident.resolved ? 'Resolved' : 'Pending'}</span></td>`;
        tbody.appendChild(tr);
      });
    }

    function updateAllIncidentsTable(){
      const tbody = document.getElementById('all-incidents-table'); tbody.innerHTML='';
      const list = [...getVisibleIncidents()].sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));
      if(list.length===0){ tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-6 text-center text-sm text-gray-500">No incident reports to display.</td></tr>`; return; }
      list.forEach(incident=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${escapeHTML(incident.name)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${escapeHTML(incident.phone)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${escapeHTML(incident.type)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${incident.severity}/10</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDateTime(incident.timestamp)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"><label class="inline-flex items-center"><input type="checkbox" class="h-5 w-5 text-blue-600" ${incident.resolved?'checked':''} onchange="toggleResolved(${incident.id})" aria-label="Toggle Resolved"></label></td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium"><button onclick="showAdminReplyModal(${incident.id})" class="text-blue-600 hover:text-blue-900 underline">Reply</button></td>`;
        tbody.appendChild(tr);
      });
    }

    function getSeverityClass(sev){ if(sev<=3) return 'severity-1-3'; if(sev<=6) return 'severity-4-6'; return 'severity-7-10'; }

    function updateEmergencyCounts(){
      emergencyTypes.forEach(type => {
        const count = incidents.filter(i => i.type === type.name && !i.resolved).length;
        const id = `${type.name.toLowerCase().replace(/[^a-z]/g,'-')}-count`;
        const el = document.getElementById(id); if(el) el.textContent = String(count);
        // neon edge when active
        const card = document.querySelector(`[data-type="${type.name}"]`);
        if(card){ if(count>0){ card.classList.add('neon'); card.style.setProperty('--glow', type.glow); } else { card.classList.remove('neon'); } }
      });
    }

    /*************** ACTIONS ***************/
    function toggleResolved(id){
      const idx = incidents.findIndex(i=>i.id===id); if(idx===-1) return;
      incidents[idx].resolved = !incidents[idx].resolved; saveIncidents(); refreshUI();
      showNotification(`Incident marked as ${incidents[idx].resolved ? 'resolved' : 'pending'}.`,'success');
    }

    function showAdminReplyModal(id){
      const incident = incidents.find(i=>i.id===id); if(!incident) return;
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 backdrop-blur-sm';
      modal.innerHTML = `
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-xl">
          <h2 class="text-xl font-bold mb-3">Reply to ${escapeHTML(incident.name)}</h2>
          <p class="text-sm text-gray-600 mb-2">Emergency: ${escapeHTML(incident.type)} (Severity: ${incident.severity}/10)</p>
          <textarea id="admin-reply-text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4" rows="4" placeholder="Enter your reply...">${incident.adminReply ? escapeHTML(incident.adminReply) : ''}</textarea>
          <div class="flex justify-end gap-3">
            <button id="cancel-reply" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">Cancel</button>
            <button id="save-reply" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition flex items-center"><span id="save-text">Save Reply</span><svg id="save-spinner" class="hidden animate-spin -mr-1 ml-2 h-5 w-5" viewBox="0 0 24 24" fill="none"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></button>
          </div>
        </div>`;
      document.body.appendChild(modal);
      document.getElementById('cancel-reply').addEventListener('click', () => modal.remove());
      document.getElementById('save-reply').addEventListener('click', () => {
        const saveBtn = document.getElementById('save-reply'); const spinner = document.getElementById('save-spinner'); const saveText = document.getElementById('save-text');
        saveBtn.disabled = true; spinner.classList.remove('hidden'); saveText.textContent = 'Saving...';
        setTimeout(()=>{ const replyText = document.getElementById('admin-reply-text').value.slice(0,2000); incident.adminReply = replyText; saveIncidents(); modal.remove(); showNotification('Reply saved successfully!','success'); refreshUI(); }, 600);
      });
    }

    function handleResetStorageClick(){
      const hard = confirm('This will clear incident data saved in your browser for this app. Continue?');
      if(!hard) return; clearAppStorage(); incidents=[]; saveIncidents(); refreshUI(); showNotification('Local storage cleared. All incidents have been reset.','warning');
    }

    function logout(){ window.location.href = 'home.html'; }

    /*************** UTIL ***************/
    function updateDate(){
      const now = new Date();
      const options = { timeZone: 'America/New_York', weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true };
      const dateStr = now.toLocaleDateString('en-US', options);
      const timeStr = now.toLocaleTimeString('en-US', { timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit', hour12: true });
      const tz = new Date().toLocaleTimeString('en-US', { timeZoneName: 'short', timeZone: 'America/New_York' }).split(' ').pop();
      document.getElementById('admin-date').textContent = `${dateStr} at ${timeStr} ${tz}`;
    }

    function showNotification(message, type='success'){
      const n = document.createElement('div'); n.className = `notification ${type}`;
      const icon = type==='success' ? 'fa-check-circle' : type==='error' ? 'fa-exclamation-circle' : type==='warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
      n.innerHTML = `<i class="fas ${icon}"></i><span>${escapeHTML(message)}</span>`; document.body.appendChild(n);
      setTimeout(()=>n.classList.add('show'), 10);
      setTimeout(()=>{ n.classList.remove('show'); setTimeout(()=>n.remove(), 300); }, 3000);
    }

    function toText(v){ if(v==null) return ''; return String(v).trim(); }
    function escapeHTML(str){ return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }
    function formatTime(ts){ const d = new Date(ts); return isNaN(d) ? '—' : d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }); }
    function formatDateTime(ts){ const d = new Date(ts); return isNaN(d) ? '—' : d.toLocaleString('en-US', { hour12: true }); }

    // Expose for inline handlers
    window.toggleResolved = toggleResolved;
    window.showAdminReplyModal = showAdminReplyModal;
  </script>
  <script src="{{ url_for('static', filename='js/frontend_bridge.js') }}"></script>
</body>
</html>
